<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cascadia Pro - è®¡åˆ†ä¸åˆ†æåŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .terrain-bonus { font-weight: 800; font-size: 0.7rem; }
        .winner-cell { background-color: #fef9c3; border: 2px solid #eab308 !important; }
        .tab-active { border-bottom: 3px solid #1e293b; color: #1e293b; }
    </style>
</head>
<body class="bg-stone-100 min-h-screen pb-20">

    <div class="max-w-5xl mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-black text-stone-800 tracking-tight">CASCADIA <span class="text-emerald-600">ANALYTICS</span></h1>
            <p class="text-stone-500 text-sm mt-2 font-medium">ä¸“ä¸šè®¡åˆ† Â· è¶‹åŠ¿åˆ†æ Â· æ•°æ®æŒä¹…åŒ–</p>
        </header>

        <div class="flex justify-center items-center gap-4 mb-8">
            <div class="bg-white p-1 rounded-2xl shadow-sm flex gap-1">
                <button onclick="setPlayers(1)" id="btn-1" class="px-6 py-2 rounded-xl font-bold transition-all">1äºº</button>
                <button onclick="setPlayers(2)" id="btn-2" class="px-6 py-2 rounded-xl font-bold transition-all">2äºº</button>
                <button onclick="setPlayers(3)" id="btn-3" class="px-6 py-2 rounded-xl font-bold transition-all">3äºº</button>
                <button onclick="setPlayers(4)" id="btn-4" class="px-6 py-2 rounded-xl font-bold transition-all">4äºº</button>
            </div>
        </div>

        <div id="players-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

        <div class="flex justify-center gap-4 mt-10">
            <button onclick="saveCurrentGame()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-8 py-3 rounded-2xl font-bold shadow-lg transition-all flex items-center gap-2">
                ğŸ’¾ ä¿å­˜æœ¬å±€è®°å½•
            </button>
            <button onclick="window.location.reload()" class="bg-white border border-stone-200 text-stone-600 px-8 py-3 rounded-2xl font-bold hover:bg-stone-50 transition-all">
                ğŸ”„ é‡ç½®æ¸…ç©º
            </button>
        </div>

        <div class="mt-12 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white rounded-3xl shadow-xl overflow-hidden border border-stone-200">
                <div class="bg-stone-800 px-6 py-4 text-white font-bold">è¡¨æ ¼å¯¹æ¯”å¯¹ç…§</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center text-sm">
                        <thead>
                            <tr class="bg-stone-50 text-stone-500">
                                <th class="p-3 text-left">è®¡åˆ†é¡¹</th>
                                <th id="th-p1" class="p-3">P1</th><th id="th-p2" class="p-3">P2</th>
                                <th id="th-p3" class="p-3">P3</th><th id="th-p4" class="p-3">P4</th>
                            </tr>
                        </thead>
                        <tbody id="summary-body"></tbody>
                        <tfoot class="bg-stone-900 text-white font-black">
                            <tr>
                                <td class="p-4 text-left">æ€»åˆ†</td>
                                <td id="total-p1" class="p-4 text-lg">-</td><td id="total-p2" class="p-4 text-lg">-</td>
                                <td id="total-p3" class="p-4 text-lg">-</td><td id="total-p4" class="p-4 text-lg">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-6 border border-stone-200">
                <h3 class="font-bold text-stone-800 mb-4 flex items-center gap-2">ğŸ“ˆ å¾—åˆ†ç»´åº¦åˆ†æ</h3>
                <canvas id="scoreChart"></canvas>
            </div>
        </div>

        <div class="mt-12 bg-white rounded-3xl shadow-lg p-6 border border-stone-200">
            <h3 class="font-bold text-stone-800 mb-4 flex justify-between items-center">
                <span>ğŸ•’ æœ€è¿‘ä¸€å‘¨è®°å½• (æœ¬åœ°å­˜å‚¨)</span>
                <span class="text-xs text-stone-400 font-normal">ä»…ä¿ç•™7å¤©å†…çš„æ•°æ®</span>
            </h3>
            <div id="history-list" class="space-y-3">
                </div>
        </div>
    </div>

    <script>
        let playerCount = 2;
        let chartInstance = null;
        const animals = [{n:'é±¼',i:'ğŸŸ'}, {n:'ç†Š',i:'ğŸ»'}, {n:'é¹°',i:'ğŸ¦…'}, {n:'é¹¿',i:'ğŸ¦Œ'}, {n:'ç‹ç‹¸',i:'ğŸ¦Š'}];
        const terrains = [
            {n:'è‰åŸ', c:'bg-yellow-50', b:'border-yellow-200', t:'text-yellow-700', ring:'focus:ring-yellow-400', bonus:'text-yellow-600'},
            {n:'æ¹¿åœ°', c:'bg-cyan-50', b:'border-cyan-200', t:'text-cyan-700', ring:'focus:ring-cyan-400', bonus:'text-cyan-600'},
            {n:'æ£®æ—', c:'bg-emerald-50', b:'border-emerald-200', t:'text-emerald-700', ring:'focus:ring-emerald-400', bonus:'text-emerald-600'},
            {n:'æ²³æµ', c:'bg-blue-50', b:'border-blue-200', t:'text-blue-700', ring:'focus:ring-blue-400', bonus:'text-blue-600'},
            {n:'å†°å·', c:'bg-slate-100', b:'border-slate-300', t:'text-slate-700', ring:'focus:ring-slate-400', bonus:'text-slate-600'}
        ];

        let scores = {};
        function initData() {
            for(let i=1; i<=4; i++) {
                scores[i] = { a: [0,0,0,0,0], t: [0,0,0,0,0], bonus: [0,0,0,0,0], leaf: 0, total: 0 };
            }
        }

        function setPlayers(n) {
            playerCount = n;
            for(let i=1; i<=4; i++) {
                document.getElementById(`btn-${i}`).className = i===n ? "px-6 py-2 rounded-xl font-bold bg-stone-800 text-white shadow-md" : "px-6 py-2 rounded-xl font-bold text-stone-400 hover:bg-stone-50";
            }
            renderInputs();
            calculate();
        }

        function renderInputs() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            for(let i=1; i<=playerCount; i++) {
                container.innerHTML += `
                <div class="bg-white rounded-3xl shadow-sm border border-stone-200 overflow-hidden">
                    <div class="bg-stone-50 border-b px-6 py-3 flex justify-between items-center font-black">
                        <span>ç©å®¶ ${i}</span>
                        <span id="card-total-${i}" class="text-emerald-600 text-xl">0</span>
                    </div>
                    <div class="p-5 space-y-6">
                        <div class="grid grid-cols-5 gap-2">
                            ${animals.map((a, idx) => `<div class="text-center"><div class="text-lg mb-1">${a.i}</div><input type="number" oninput="updateVal(${i},'a',${idx},this.value)" class="w-full bg-stone-50 border rounded-lg p-1.5 text-center font-bold outline-none focus:ring-2 focus:ring-stone-300" placeholder="0"></div>`).join('')}
                        </div>
                        <div class="grid grid-cols-5 gap-2">
                            ${terrains.map((t, idx) => `<div class="text-center"><div class="text-[10px] font-bold ${t.t}">${t.n}</div><input type="number" oninput="updateVal(${i},'t',${idx},this.value)" class="w-full ${t.c} border ${t.b} rounded-lg p-1.5 text-center font-bold outline-none ${t.ring}" placeholder="0"><div id="bonus-${i}-${idx}" class="terrain-bonus h-4 text-rose-500"></div></div>`).join('')}
                        </div>
                        <div class="flex items-center justify-between bg-orange-50 p-3 rounded-2xl border border-orange-100">
                            <span class="text-sm font-bold text-orange-700">ğŸƒ è‡ªç„¶æ ‡è®° (å¶å­)</span>
                            <input type="number" oninput="updateVal(${i},'leaf',0,this.value)" class="w-16 bg-white border border-orange-200 rounded-lg p-1.5 text-center font-bold text-orange-700 outline-none focus:ring-2 focus:ring-orange-400">
                        </div>
                    </div>
                </div>`;
            }
        }

        function updateVal(p, type, idx, val) {
            const v = parseInt(val) || 0;
            if(type === 'a') scores[p].a[idx] = v;
            else if(type === 't') scores[p].t[idx] = v;
            else scores[p].leaf = v;
            calculate();
        }

        function calculate() {
            // é‡ç½®å¥–åŠ±
            for(let p=1; p<=4; p++) scores[p].bonus = [0,0,0,0,0];
            // è®¡ç®—é€»è¾‘
            for(let ti=0; ti<5; ti++) {
                let list = [];
                for(let p=1; p<=playerCount; p++) list.push({id:p, s:scores[p].t[ti]});
                if(playerCount < 2) continue;
                list.sort((a,b)=>b.s-a.s);
                const maxS = list[0].s;
                if(maxS === 0) continue;
                const firstG = list.filter(x=>x.s === maxS);
                if(playerCount === 2) {
                    if(firstG.length === 1) scores[firstG[0].id].bonus[ti] = 2;
                } else {
                    if(firstG.length >= 2) firstG.forEach(x=>scores[x.id].bonus[ti] = 1);
                    else {
                        scores[list[0].id].bonus[ti] = 2;
                        const secS = list.find(x=>x.s < maxS)?.s || 0;
                        if(secS > 0 && list.filter(x=>x.s === secS).length === 1) {
                            scores[list.find(x=>x.s === secS).id].bonus[ti] = 1;
                        }
                    }
                }
            }
            // æ±‡æ€»
            for(let i=1; i<=playerCount; i++) {
                const aTot = scores[i].a.reduce((a,b)=>a+b,0);
                const tTot = scores[i].t.reduce((a,b)=>a+b,0) + scores[i].bonus.reduce((a,b)=>a+b,0);
                scores[i].total = aTot + tTot + scores[i].leaf;
                document.getElementById(`card-total-${i}`).innerText = scores[i].total;
                scores[i].bonus.forEach((b, ti) => document.getElementById(`bonus-${i}-${ti}`).innerText = b>0?`+${b}`:'');
            }
            renderTable();
            updateChart();
        }

        function renderTable() {
            const body = document.getElementById('summary-body');
            body.innerHTML = '';
            for(let i=1; i<=4; i++) {
                document.getElementById(`th-p${i}`).style.display = i<=playerCount?'':'none';
                document.getElementById(`total-p${i}`).style.display = i<=playerCount?'':'none';
                document.getElementById(`total-p${i}`).innerText = i<=playerCount?scores[i].total:'';
            }
            const rows = [
                ...animals.map((a,idx)=>({n:a.i+' '+a.n, k:'a', idx})),
                ...terrains.map((t,idx)=>({n:'ğŸ—ºï¸ '+t.n, k:'t', idx})),
                {n:'ğŸƒ å¶å­', k:'leaf', idx:-1}
            ];
            rows.forEach(row => {
                let html = `<tr class="border-b border-stone-100"><td class="p-3 text-left text-stone-400 font-bold">${row.n}</td>`;
                let vals = [];
                for(let p=1; p<=playerCount; p++) vals.push(row.idx===-1?scores[p][row.k]:scores[p][row.k][row.idx]);
                let max = Math.max(...vals);
                for(let p=1; p<=playerCount; p++) {
                    let v = row.idx===-1?scores[p][row.k]:scores[p][row.k][row.idx];
                    html += `<td class="p-3 ${v===max && max>0 && playerCount>1 ? 'winner-cell font-bold text-emerald-600':''}">${v}</td>`;
                }
                body.innerHTML += html + `</tr>`;
            });
        }

        function updateChart() {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            const datasets = [];
            const colors = ['#059669', '#2563eb', '#d97706', '#7c3aed'];

            for(let i=1; i<=playerCount; i++) {
                datasets.push({
                    label: `ç©å®¶ ${i}`,
                    data: [
                        scores[i].a.reduce((a,b)=>a+b,0),
                        scores[i].t.reduce((a,b)=>a+b,0) + scores[i].bonus.reduce((a,b)=>a+b,0),
                        scores[i].leaf
                    ],
                    backgroundColor: colors[i-1],
                    borderColor: colors[i-1],
                    borderWidth: 1
                });
            }

            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['åŠ¨ç‰©æ€»è®¡', 'åœ°å½¢æ€»è®¡', 'è‡ªç„¶æ ‡è®°'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // å†å²è®°å½•ä¸æŒä¹…åŒ–
        function saveCurrentGame() {
            const history = JSON.parse(localStorage.getItem('cascadia_history') || '[]');
            const record = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                timestamp: Date.now(),
                playerCount: playerCount,
                scores: JSON.parse(JSON.stringify(scores))
            };
            history.unshift(record);
            localStorage.setItem('cascadia_history', JSON.stringify(history));
            alert('æœ¬å±€åˆ†æ•°å·²å­˜å…¥å†å²è®°å½•ï¼');
            loadHistory();
        }

        function loadHistory() {
            const historyList = document.getElementById('history-list');
            let history = JSON.parse(localStorage.getItem('cascadia_history') || '[]');
            const ONE_WEEK = 7 * 24 * 60 * 60 * 1000;
            const now = Date.now();

            // è¿‡æ»¤å‡ºä¸€å‘¨å†…çš„
            history = history.filter(item => (now - item.timestamp) < ONE_WEEK);
            localStorage.setItem('cascadia_history', JSON.stringify(history));

            if(history.length === 0) {
                historyList.innerHTML = '<p class="text-stone-400 text-sm italic">æš‚æ— ä¸€å‘¨å†…è®°å½•</p>';
                return;
            }

            historyList.innerHTML = history.map(item => {
                const winnerScore = Math.max(...Object.values(item.scores).slice(0, item.playerCount).map(s=>s.total));
                return `
                <div class="flex items-center justify-between p-4 bg-stone-50 rounded-2xl border border-stone-100">
                    <div>
                        <div class="text-xs text-stone-400">${item.date}</div>
                        <div class="font-bold text-stone-700">${item.playerCount} äººå¯¹å±€</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-stone-400">æœ€é«˜åˆ†</div>
                        <div class="text-lg font-black text-emerald-600">${winnerScore}</div>
                    </div>
                </div>`;
            }).join('');
        }

        initData();
        setPlayers(2);
        loadHistory();
    </script>
</body>
</html>