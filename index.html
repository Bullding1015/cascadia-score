<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cascadia è®¡åˆ†åŠ©æ‰‹ Pro - åœ°æ ‡æ‰©å±•ç‰ˆ</title>

    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="shortcut icon" href="icon.png">
    <meta name="theme-color" content="#1c1917">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .terrain-bonus { font-weight: 800; font-size: 0.65rem; }
        .winner-cell { background-color: #fef9c3; border: 2px solid #eab308 !important; }
        button, input { outline: none !important; }
        /* é’ˆå¯¹åç§°è¾“å…¥çš„æ ·å¼ */
        .name-input { background: transparent; border: none; font-weight: 900; width: 100%; }
        .name-input:focus { background: rgba(255,255,255,0.5); border-radius: 4px; }
    </style>
</head>
<body class="bg-stone-100 min-h-screen pb-24 text-stone-800">

    <div class="max-w-5xl mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-black text-stone-800 tracking-tight italic">CASCADIA <span class="text-emerald-600">LANDMARKS</span></h1>
            <p class="text-stone-400 text-xs mt-2 font-bold uppercase tracking-widest">åœ°æ ‡æ‰©å±•å¢å¼ºç‰ˆ v3.5</p>
        </header>

        <div class="flex justify-center items-center gap-4 mb-8">
            <div class="bg-white p-1 rounded-2xl shadow-sm border border-stone-200 flex gap-1">
                <button onclick="setPlayers(1)" id="btn-1" class="px-5 py-2 rounded-xl font-bold transition-all">1äºº</button>
                <button onclick="setPlayers(2)" id="btn-2" class="px-5 py-2 rounded-xl font-bold transition-all">2äºº</button>
                <button onclick="setPlayers(3)" id="btn-3" class="px-5 py-2 rounded-xl font-bold transition-all">3äºº</button>
                <button onclick="setPlayers(4)" id="btn-4" class="px-5 py-2 rounded-xl font-bold transition-all">4äºº</button>
            </div>
        </div>

        <div id="players-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>

        <div class="flex flex-col sm:flex-row justify-center gap-4 mt-10">
            <button onclick="saveCurrentGame()" class="bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black shadow-lg shadow-emerald-100 flex items-center justify-center gap-2">
                <span>ğŸ’¾</span> ä¿å­˜æœ¬å±€æ•°æ®
            </button>
            <button onclick="resetCurrentScores()" class="bg-white border border-stone-200 text-stone-400 px-8 py-4 rounded-2xl font-bold">
                ğŸ”„ é‡ç½®æœ¬å±€
            </button>
        </div>

        <div class="mt-12 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white rounded-3xl shadow-xl overflow-hidden border border-stone-200">
                <div class="bg-stone-800 px-6 py-4 text-white font-bold flex justify-between items-center text-sm">
                    <span>ğŸ“Š å¯¹æ¯”åˆ†æ</span>
                    <span class="text-[10px] text-stone-400">LANDMARK SCORES INCLUDED</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-center text-sm">
                        <thead id="summary-head"></thead>
                        <tbody id="summary-body" class="text-stone-600"></tbody>
                        <tfoot id="summary-foot" class="bg-stone-900 text-white font-black"></tfoot>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-xl p-6 border border-stone-200">
                <h3 class="font-black text-stone-800 mb-4 flex items-center gap-2">ğŸ“ˆ ç»´åº¦é€è§†</h3>
                <div class="relative h-64">
                    <canvas id="scoreChart"></canvas>
                </div>
            </div>
        </div>

        <div id="history-list" class="mt-12 space-y-3 px-2"></div>
    </div>

    <script>
        let playerCount = 2;
        let chartInstance = null;
        const animals = [{n:'é±¼',i:'ğŸŸ'}, {n:'ç†Š',i:'ğŸ»'}, {n:'é¹°',i:'ğŸ¦…'}, {n:'é¹¿',i:'ğŸ¦Œ'}, {n:'ç‹ç‹¸',i:'ğŸ¦Š'}];
        const terrains = [
            {n:'è‰åŸ', c:'bg-yellow-50', b:'border-yellow-200', t:'text-yellow-700', ring:'focus:ring-yellow-400', bonus:'text-yellow-600'},
            {n:'æ¹¿åœ°', c:'bg-cyan-50', b:'border-cyan-200', t:'text-cyan-700', ring:'focus:ring-cyan-400', bonus:'text-cyan-600'},
            {n:'æ£®æ—', c:'bg-emerald-50', b:'border-emerald-200', t:'text-emerald-700', ring:'focus:ring-emerald-400', bonus:'text-emerald-600'},
            {n:'æ²³æµ', c:'bg-blue-50', b:'border-blue-200', t:'text-blue-700', ring:'focus:ring-blue-400', bonus:'text-blue-600'},
            {n:'å†°å·', c:'bg-slate-100', b:'border-slate-300', t:'text-slate-700', ring:'focus:ring-slate-400', bonus:'text-slate-600'}
        ];

        let scores = {};
        function initData() {
            for(let i=1; i<=4; i++) {
                if(!scores[i]) {
                    scores[i] = { 
                        name: `ç©å®¶ ${i}`, 
                        a: [0,0,0,0,0], 
                        t: [0,0,0,0,0], 
                        l: [0,0,0,0,0], // åœ°æ ‡åˆ†
                        bonus: [0,0,0,0,0], 
                        leaf: 0, 
                        total: 0 
                    };
                }
            }
        }

        function setPlayers(n) {
            playerCount = n;
            for(let i=1; i<=4; i++) {
                document.getElementById(`btn-${i}`).className = i===n ? "px-6 py-2 rounded-xl font-bold bg-stone-800 text-white shadow-md" : "px-6 py-2 rounded-xl font-bold text-stone-400";
            }
            renderInputs();
            calculate();
        }

        function updateName(p, val) {
            scores[p].name = val || `ç©å®¶ ${p}`;
            renderTable();
            updateChart();
        }

        function renderInputs() {
            const container = document.getElementById('players-container');
            container.innerHTML = '';
            for(let i=1; i<=playerCount; i++) {
                container.innerHTML += `
                <div class="bg-white rounded-3xl shadow-sm border border-stone-200 overflow-hidden">
                    <div class="bg-stone-50 border-b px-6 py-4 flex justify-between items-center">
                        <input type="text" value="${scores[i].name}" oninput="updateName(${i}, this.value)" class="name-input text-stone-800 text-lg" placeholder="è¾“å…¥åç§°...">
                        <span id="card-total-${i}" class="text-emerald-600 text-2xl font-black">0</span>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-5 gap-2">
                            ${animals.map((a, idx) => `<div class="text-center"><div class="text-lg mb-1">${a.i}</div><input type="number" value="${scores[i].a[idx]||''}" oninput="updateVal(${i},'a',${idx},this.value)" class="w-full bg-stone-50 border border-stone-100 rounded-xl p-2 text-center font-bold outline-none focus:ring-2 focus:ring-stone-300" placeholder="0"></div>`).join('')}
                        </div>
                        <div class="grid grid-cols-5 gap-2 border-t pt-4">
                            ${terrains.map((t, idx) => `
                                <div class="text-center space-y-2">
                                    <div class="text-[10px] font-black ${t.t}">${t.n}</div>
                                    <input type="number" value="${scores[i].t[idx]||''}" oninput="updateVal(${i},'t',${idx},this.value)" class="w-full ${t.c} border ${t.b} rounded-xl p-2 text-center font-bold outline-none ${t.ring}" placeholder="åœ°">
                                    <input type="number" value="${scores[i].l[idx]||''}" oninput="updateVal(${i},'l',${idx},this.value)" class="w-full bg-white border ${t.b} rounded-xl p-2 text-center text-xs font-bold outline-none ${t.ring}" placeholder="æ ‡">
                                    <div id="bonus-${i}-${idx}" class="terrain-bonus h-3 text-rose-500"></div>
                                </div>`).join('')}
                        </div>
                        <div class="flex items-center justify-between bg-orange-50/50 p-3 rounded-2xl border border-orange-100">
                            <span class="text-sm font-black text-orange-700">ğŸƒ è‡ªç„¶æ ‡è®°</span>
                            <input type="number" value="${scores[i].leaf||''}" oninput="updateVal(${i},'leaf',0,this.value)" class="w-20 bg-white border border-orange-200 rounded-xl p-2 text-center font-black text-orange-700 outline-none focus:ring-2 focus:ring-orange-300">
                        </div>
                    </div>
                </div>`;
            }
        }

        function updateVal(p, type, idx, val) {
            const v = parseInt(val) || 0;
            if(type === 'leaf') scores[p].leaf = v;
            else scores[p][type][idx] = v;
            calculate();
        }

        function calculate() {
            for(let p=1; p<=4; p++) scores[p].bonus = [0,0,0,0,0];
            for(let ti=0; ti<5; ti++) {
                let list = [];
                for(let p=1; p<=playerCount; p++) list.push({id:p, s:scores[p].t[ti]});
                if(playerCount < 2) continue;
                list.sort((a,b)=>b.s-a.s);
                const maxS = list[0].s;
                if(maxS === 0) continue;
                const firstG = list.filter(x=>x.s === maxS);
                if(playerCount === 2) {
                    if(firstG.length === 1) scores[firstG[0].id].bonus[ti] = 2;
                } else {
                    if(firstG.length >= 2) firstG.forEach(x=>scores[x.id].bonus[ti] = 1);
                    else {
                        scores[list[0].id].bonus[ti] = 2;
                        const secS = list.find(x=>x.s < maxS)?.s || 0;
                        if(secS > 0 && list.filter(x=>x.s === secS).length === 1) {
                            scores[list.find(x=>x.s === secS).id].bonus[ti] = 1;
                        }
                    }
                }
            }
            for(let i=1; i<=playerCount; i++) {
                const aTot = scores[i].a.reduce((a,b)=>a+b,0);
                const tBase = scores[i].t.reduce((a,b)=>a+b,0);
                const tBonus = scores[i].bonus.reduce((a,b)=>a+b,0);
                const lTot = scores[i].l.reduce((a,b)=>a+b,0);
                scores[i].total = aTot + tBase + tBonus + lTot + scores[i].leaf;
                document.getElementById(`card-total-${i}`).innerText = scores[i].total;
                scores[i].bonus.forEach((b, ti) => {
                    const el = document.getElementById(`bonus-${i}-${ti}`);
                    if(el) el.innerText = b>0?`+${b}`:'';
                });
            }
            renderTable();
            updateChart();
        }

        function renderTable() {
            const head = document.getElementById('summary-head');
            const body = document.getElementById('summary-body');
            const foot = document.getElementById('summary-foot');
            
            let headHtml = `<tr class="bg-stone-50 text-stone-400 text-[10px] font-black uppercase"><th class="p-4 text-left">é¡¹ç›®</th>`;
            let footHtml = `<tr><td class="p-5 text-left text-xs uppercase">æœ€ç»ˆå¾—åˆ†</td>`;
            
            for(let i=1; i<=playerCount; i++) {
                headHtml += `<th class="p-4">${scores[i].name}</th>`;
            }
            head.innerHTML = headHtml + `</tr>`;

            let rows = [
                ...animals.map((a,idx)=>({n:a.i+' '+a.n, k:'a', idx})),
                ...terrains.map((t,idx)=>({n:t.n+' åœ°å½¢', k:'t', idx})),
                ...terrains.map((t,idx)=>({n:t.n+' åœ°æ ‡', k:'l', idx})),
                {n:'ğŸƒ è‡ªç„¶æ ‡è®°', k:'leaf', idx:-1}
            ];

            body.innerHTML = rows.map(row => {
                let html = `<tr class="border-b border-stone-50"><td class="p-3 text-left font-bold text-xs">${row.n}</td>`;
                let vals = [];
                for(let p=1; p<=playerCount; p++) vals.push(row.idx===-1?scores[p][row.k]:scores[p][row.k][row.idx]);
                let max = Math.max(...vals);
                for(let p=1; p<=playerCount; p++) {
                    let v = row.idx===-1?scores[p][row.k]:scores[p][row.k][row.idx];
                    html += `<td class="p-3 tabular-nums ${v===max && max>0 && playerCount>1 ? 'winner-cell font-black text-emerald-600':''}">${v}</td>`;
                }
                return html + `</tr>`;
            }).join('');

            let totals = [];
            for(let i=1; i<=playerCount; i++) totals.push(scores[i].total);
            let winScore = Math.max(...totals);

            for(let i=1; i<=playerCount; i++) {
                footHtml += `<td class="p-5 text-2xl font-black ${scores[i].total===winScore && winScore>0 ? 'text-yellow-400':''}">${scores[i].total}</td>`;
            }
            foot.innerHTML = footHtml + `</tr>`;
        }

        function updateChart() {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            const colors = ['#059669', '#2563eb', '#d97706', '#7c3aed'];
            const datasets = [];
            for(let i=1; i<=playerCount; i++) {
                datasets.push({
                    label: scores[i].name,
                    data: [
                        scores[i].a.reduce((a,b)=>a+b,0),
                        scores[i].t.reduce((a,b)=>a+b,0) + scores[i].bonus.reduce((a,b)=>a+b,0),
                        scores[i].l.reduce((a,b)=>a+b,0),
                        scores[i].leaf
                    ],
                    backgroundColor: colors[i-1] + 'CC',
                    borderColor: colors[i-1],
                    borderRadius: 6
                });
            }
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['åŠ¨ç‰©', 'åœ°å½¢', 'åœ°æ ‡', 'æ ‡è®°'], datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } },
                    scales: { y: { beginAtZero: true, grid: { display: false } } }
                }
            });
        }

        function saveCurrentGame() {
            const history = JSON.parse(localStorage.getItem('cascadia_history') || '[]');
            history.unshift({
                id: Date.now(),
                date: new Date().toLocaleString('zh-CN', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}),
                timestamp: Date.now(),
                playerCount,
                scores: JSON.parse(JSON.stringify(scores))
            });
            localStorage.setItem('cascadia_history', JSON.stringify(history));
            loadHistory();
            alert('æˆ˜ç»©å·²å­˜å…¥æœ¬åœ°è®°å½•ï¼');
        }

        function loadHistory() {
            const list = document.getElementById('history-list');
            let history = JSON.parse(localStorage.getItem('cascadia_history') || '[]');
            history = history.filter(item => (Date.now() - item.timestamp) < 7*24*60*60*1000);
            localStorage.setItem('cascadia_history', JSON.stringify(history));
            if(history.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-stone-300 text-xs font-bold border-2 border-dashed border-stone-200 rounded-3xl uppercase tracking-widest">No History</div>';
                return;
            }
            list.innerHTML = history.slice(0, 5).map(item => {
                const winnerScore = Math.max(...Object.values(item.scores).slice(0, item.playerCount).map(s=>s.total));
                return `<div class="bg-white p-4 rounded-2xl border border-stone-100 flex justify-between items-center shadow-sm">
                    <div><div class="text-[10px] text-stone-300 font-bold uppercase">${item.date}</div><div class="text-stone-800 font-black text-sm">${item.playerCount} äººå¯¹æˆ˜</div></div>
                    <div class="text-right"><div class="text-[10px] text-stone-300 font-bold uppercase">Winner</div><div class="text-xl font-black text-emerald-600">${winnerScore}</div></div>
                </div>`;
            }).join('');
        }

        function resetCurrentScores() {
            if(confirm('ç¡®å®šæ¸…ç©ºæœ¬å±€å¾—åˆ†å—ï¼Ÿåç§°å°†è¢«ä¿ç•™ã€‚')) {
                for(let i=1; i<=4; i++) {
                    scores[i].a = [0,0,0,0,0];
                    scores[i].t = [0,0,0,0,0];
                    scores[i].l = [0,0,0,0,0];
                    scores[i].leaf = 0;
                    scores[i].total = 0;
                }
                renderInputs();
                calculate();
            }
        }

        initData();
        setPlayers(2);
        loadHistory();
    </script>
</body>
</html>
